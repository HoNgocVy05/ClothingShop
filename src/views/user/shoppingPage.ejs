<div class="shopping-page">
    <!-- LEFT -->
    <div class="order-left">
        <h2>Mua hàng</h2>

        <div class="form-group">
            <label>Họ và tên</label>
            <input type="text" placeholder="Nhập họ và tên" required>
        </div>

        <div class="form-group">
            <label>Số điện thoại</label>
            <input type="tel" placeholder="Nhập số điện thoại" required>
        </div>

        <div class="form-group">
            <label>Tỉnh/Thành phố, Quận/Huyện, Phường/Xã</label>
            <input type="text" placeholder="Ví dụ: TP. Hồ Chí Minh, Quận 1, Phường Bến Nghé" required>
        </div>

        <div class="form-group">
            <label>Tên đường, Tòa nhà, Số nhà</label>
            <input type="text" placeholder="Ví dụ: 123 Đường Lê Lợi, Chung cư ABC, Lầu 5" required>
        </div>

        <div class="form-group">
            <label>Ghi chú</label>
            <textarea rows="4" placeholder="Ghi chú thêm cho shop (không bắt buộc)"></textarea>
        </div>

        <div class="shipping-method">
            <div class="shipping-box">
                <strong>Phí vận chuyển</strong>
                <span class="price">
                    <%= shipping.toLocaleString() %>đ
                </span>
            </div>
        </div>

        <div class="payment-method">
            <strong>Phương thức thanh toán</strong>

            <!-- <input type="radio" name="payment" id="online" checked>
            <label for="online">
                <div class="radio-custom"></div>
                <div class="payment-title">Credit / ATM / QR</div>
                <div class="payment-logos">
                    <img src="/images/payment.png" class="payment-single-logo">
                </div>
            </label> -->

            <input type="radio" name="payment" id="momo">
            <label for="momo">
                <div class="radio-custom"></div>
                <div class="payment-title">Ví Momo</div>
                <div class="payment-logos">
                    <img src="/images/momo.png" style="height:28px;">
                </div>
            </label>

            <input type="radio" name="payment" id="cod">
            <label for="cod">
                <div class="radio-custom"></div>
                <span class="payment-cod">Thanh toán khi nhận hàng (COD)</span>
            </label>
        </div>

        <!-- GẮN DATA-TOTAL -->
        <button class="btn-checkout" data-total="<%= total %>">
            Tiến hành thanh toán
        </button>
    </div>

    <!-- RIGHT -->
    <div class="order-right">
        <div class="my-order">
            <div class="order-item">
                <div class="order-products-detail">

                    <% if (items && items.length > 0) { %>
                        <% items.forEach(item => { %>
                            <div class="order-product">
                                <img src="/uploads/products/<%= item.image %>" alt="<%= item.name %>">
                                <div class="order-product-info">
                                    <p class="order-product-name"><%= item.name %></p>
                                    <p class="order-product-size"><%= item.size %></p>
                                    <div class="price-row">
                                        <p>x<%= item.quantity %></p>
                                        <p>
                                            <%= (item.price * item.quantity).toLocaleString() %>đ
                                        </p>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <p>Không có sản phẩm nào.</p>
                    <% } %>

                </div>
            </div>
        </div>

        <div class="checkout-summary">
            <div class="sum-row">
                <span>Tổng phụ</span>
                <strong><%= subTotal.toLocaleString() %>đ</strong>
            </div>
            <div class="sum-row">
                <span>Vận chuyển</span>
                <span><%= shipping.toLocaleString() %>đ</span>
            </div>
            <div class="sum-total">
                <span>Tổng</span>
                <strong><%= total.toLocaleString() %>đ</strong>
            </div>
        </div>  
    </div>
</div>

<script>
document.querySelector('.btn-checkout').addEventListener('click', async () => {
    const form = document.querySelector('.order-left');
    const btn = document.querySelector('.btn-checkout');

    const data = {
        fullname: form.querySelectorAll('input[type="text"]')[0].value,
        phone: form.querySelector('input[type="tel"]').value,
        address:
            form.querySelectorAll('input[type="text"]')[1].value + ' - ' +
            form.querySelectorAll('input[type="text"]')[2].value,
        note: form.querySelector('textarea').value,
        payment: document.querySelector('input[name="payment"]:checked').id,
        total: Number(btn.dataset.total)
    };

    const res = await fetch('/checkout/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });

    const result = await res.json();

    if (res.ok && result.success) {
        alert('Đặt hàng thành công');
        window.location.href = '/my-order';
    } else {
        alert(result.message || 'Có lỗi xảy ra');
    }
});
</script>
