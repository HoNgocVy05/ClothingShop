<% 
  // fallback an toàn nếu product = null/undefined
  const prod = product || {
    id: null,
    name: 'Không tìm được thông tin sản phẩm',
    images: [],
    price: 0,
    final_price: 0,
    description: '',
    stock_s: 0,
    stock_m: 0,
    stock_l: 0,
    stock_xl: 0,
    image: '',
    imagesArray: []
  };
%>

<div class="product-infor-page">
    <div class="product-wrapper">

        <!-- Hình ảnh sản phẩm -->
        <div class="product-image">
            <div class="main-img">
                <img id="mainImage" 
                     src="/uploads/products/<%= (prod.imagesArray && prod.imagesArray.length > 0) ? prod.imagesArray[0] : 'img-product-default.png' %>" 
                     alt="<%= prod.name %>" />
            </div>

            <div class="thumbnails">
                <% if (prod.imagesArray && prod.imagesArray.length > 0) { %>
                    <% prod.imagesArray.forEach(img => { %>
                        <img class="thumbnails-img" src="/uploads/products/<%= img %>" alt="Thumb" onclick="changeMainImage(this)" />
                    <% }) %>
                <% } %>
            </div>
        </div>

        <!-- Thông tin sản phẩm -->
        <div class="product-info-page">
            <h1 class="product-title"><%= prod.name %></h1>

            <div class="product-price">
                <p class="discount-price"><%= Number(prod.final_price || prod.price).toLocaleString() %>đ</p>
                <p class="origin-price"><%= Number(prod.price || 0).toLocaleString() %>đ</p>
            </div>

            <div class="product-review-simple">
                <div class="product-rated"><p><i class="fa-solid fa-star"></i> 4.9</p></div>
                <div class="product-sold"><p>3k+ đã bán</p></div>
            </div>

            <div id="productData"
                 data-id="<%= prod.id %>"
                 data-stock-s="<%= Number(prod.stock_s || 0) %>"
                 data-stock-m="<%= Number(prod.stock_m || 0) %>"
                 data-stock-l="<%= Number(prod.stock_l || 0) %>"
                 data-stock-xl="<%= Number(prod.stock_xl || 0) %>">
            </div>

            <!-- SIZE -->
            <div class="size-options">
                <label>Size</label>
                <div class="size-list">
                    <button class="size-btn <%= prod.stock_s > 0 ? '' : 'disabled' %> selected" 
                            onclick="<%= prod.stock_s > 0 ? 'selectSize(this)' : '' %>" 
                            <%= prod.stock_s > 0 ? '' : 'disabled' %>>S</button>
                    <button class="size-btn <%= prod.stock_m > 0 ? '' : 'disabled' %>" 
                            onclick="<%= prod.stock_m > 0 ? 'selectSize(this)' : '' %>" 
                            <%= prod.stock_m > 0 ? '' : 'disabled' %>>M</button>
                    <button class="size-btn <%= prod.stock_l > 0 ? '' : 'disabled' %>" 
                            onclick="<%= prod.stock_l > 0 ? 'selectSize(this)' : '' %>" 
                            <%= prod.stock_l > 0 ? '' : 'disabled' %>>L</button>
                    <button class="size-btn <%= prod.stock_xl > 0 ? '' : 'disabled' %>" 
                            onclick="<%= prod.stock_xl > 0 ? 'selectSize(this)' : '' %>" 
                            <%= prod.stock_xl > 0 ? '' : 'disabled' %>>XL</button>
                </div>
            </div>

            <!-- Số lượng -->
            <div class="quantity">
                <label>Số lượng</label>
                <div class="quantity-controls">
                    <button class="quantity-btn" onclick="changeQuantity(-1)">-</button>
                    <input type="text" class="quantity-input" value="1" id="quantity" readonly />
                    <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
                    <span class="stock-info">
                        (còn <%= Number(prod.stock_s + prod.stock_m + prod.stock_l + prod.stock_xl || 0) %> sản phẩm)
                    </span>
                </div>
            </div>

            <!-- Nút hành động -->
            <div class="actions">
                <button class="btn btn-cart" 
                        id="addToCart"
                        data-id="<%= prod.id %>"
                        data-name="<%= prod.name %>"
                        data-price="<%= prod.price %>"
                        data-image="<%= prod.image %>">
                    <i class="fa-solid fa-cart-shopping cart-icon"></i>
                    Thêm vào giỏ hàng
                </button>

                <button class="btn btn-buy">MUA NGAY</button>
            </div>
        </div>
    </div>

    <!-- MÔ TẢ SẢN PHẨM -->
    <div class="dropdown-box">
        <div class="dropdown-description" onclick="toggleDropdown('desc')">
            <div class="icon-text">
                <i class="fa-solid fa-circle-exclamation"></i>
                Mô tả sản phẩm
                <span class="arrow">▼</span>
            </div>
        </div>

        <div class="dropdown-content" id="desc">
            <%= prod.description %>
        </div>
    </div>

    <!-- GIAO HÀNG -->
    <div class="dropdown-box">
        <div class="dropdown-shipping" onclick="toggleDropdown('shipping')">
            <div class="icon-text">
                <i class="fa-solid fa-truck-fast truck-icon"></i>
                Thời gian nhận hàng
                <span class="arrow">▼</span>
            </div>
        </div>

        <div class="dropdown-content" id="shipping">
            <b>TIÊU CHUẨN:</b> 10-15 ngày<br />
            Không bao gồm thời gian xử lý hải quan 7-10 ngày.<br /><br />
            Thời gian vận chuyển do các hãng chuyển phát cung cấp và có thể thay đổi tùy thuộc vào địa điểm và điều kiện bên ngoài.<br /><br />
            Trong thời gian bán hàng, vui lòng cho phép thêm thời gian. Không giao hàng đến hộp thư Bưu điện hoặc Tủ đựng Bưu kiện.
        </div>
    </div>
</div>

<script>
    // đổi ảnh 
    function changeMainImage(thumbnail) {
        const mainImg = document.getElementById("mainImage");
        const thumbnailsImg = document.querySelectorAll('.thumbnails-img');
        mainImg.src = thumbnail.src;
        thumbnailsImg.forEach(img => img.classList.remove('active'));
        thumbnail.classList.add('active');
    }

    // đóng mở dropdown 
    function toggleDropdown(type) {
        const content = document.getElementById(type);
        const arrow = content.previousElementSibling.querySelector(".arrow");
        content.classList.toggle("open");
        arrow.classList.toggle("open");
    }

    // chọn size    
    function selectSize(button) {
        const allSize = document.querySelectorAll('.size-btn');
        allSize.forEach(btn => btn.classList.remove('selected'));
        button.classList.add('selected');
    }

    function changeQuantity(change) {
        const input = document.getElementById("quantity");
        let current = parseInt(input.value);
        let newValue = current + change;
        if (newValue < 1) newValue = 1;
        const maxStock = 25; // giới hạn max
        if (newValue > maxStock) newValue = maxStock;
        input.value = newValue;
    }

    document.getElementById("addToCart").onclick = function () {
        const btn = this;
        const size = document.querySelector(".size-btn.selected")?.innerText;
        if (!size) return alert("Chọn size trước!");

        const quantity = Number(document.getElementById("quantity").value);

        fetch("/cart/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                productId: btn.dataset.id,
                name: btn.dataset.name,
                price: Number(btn.dataset.price),
                image: btn.dataset.image,
                size,
                quantity
            })
        })
        .then(res => res.json())
        .then(data => {
            document.querySelector(".cart-count").innerText = data.cartCount;
            alert(`Đã thêm ${quantity} sản phẩm vào giỏ!`);
        })
        .catch(err => console.log("Lỗi:", err));
    };
</script>
