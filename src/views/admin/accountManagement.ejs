<div class="admin-container dashboard">
  <h1>Quản lý tài khoản</h1>
  <div class="statistical-best-seller statistical-time">
    <div class="admin-table order-management-table">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Họ và tên</th>
            <th>Email</th>
            <th>Vai trò</th>
            <th>Trạng thái</th>
            <% if (adminEmail===mainAdminEmail) { %>
              <th>Hành động</th>
              <% } %>
          </tr>
        </thead>
        <tbody>
          <% users.forEach(user=> { %>
            <tr>
              <td>
                <%= user.id %>
              </td>
              <td>
                <%= user.fullname %>
              </td>
              <td>
                <%= user.email %>
              </td>
              <td>
                <%= user.role %>
              </td>
              <td>
                <%= user.isActive ? 'Hoạt động' : 'Đã khóa' %>
              </td>

              <% if (adminEmail===mainAdminEmail) { %>
                <td>
                  <% if (user.role==='user' ) { %>
                    <button class="toggle-btn" data-id="<%= user.id %>" data-status="<%= user.isActive ? 0 : 1 %>"
                      onclick="handleToggle(this)">
                      <%= user.isActive ? 'Khóa' : 'Mở khóa' %>
                    </button>
                    <% } else if (user.role==='admin' && user.email !==mainAdminEmail) { %>
                      <button class="delete-btn" data-id="<%= user.id %>" onclick="handleDelete(this)">Xóa
                      </button>
                      <% } %>
                </td>
                <% } %>
            </tr>
            <% }); %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  async function handleDelete(btn) {
    const id = btn.dataset.id;

    if (!confirm('Bạn có chắc muốn xóa tài khoản này không?')) return;

    const res = await fetch('/admin/account-management/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    });

    const data = await res.json();
    alert(data.message);
    if (data.success) location.reload();
  }

  async function handleToggle(btn) {
    const id = btn.dataset.id;
    const status = btn.dataset.status;

    const res = await fetch('/admin/account-management/toggle-status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, status })
    });

    const data = await res.json();
    alert(data.message);
    if (data.success) location.reload();
  }
</script>
